window.RPRESS_Checkout=function($){"use strict";var $body,$form,$rpress_cart_amount,$checkout_form_wrap;function apply_discount(event){event.preventDefault();$(this);var discount_code=$("#rpress-discount").val(),rpress_discount_loader=$("#rpress-discount-loader");if(""==discount_code||discount_code==rpress_global_vars.enter_discount)return!1;var postData={action:"rpress_apply_discount",code:discount_code,form:$("#rpress_purchase_form").serialize()};return $("#rpress-discount-error-wrap").html("").hide(),rpress_discount_loader.show(),$.ajax({type:"POST",data:postData,dataType:"json",url:rpress_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(discount_response){if(discount_response)if("valid"==discount_response.msg){$(".rpress_cart_discount").html(discount_response.html),$(".rpress_cart_discount_row").show(),$(".rpress_cart_amount").each(function(){$(this).text(discount_response.total),$(this).data("total",discount_response.total_plain)}),$("#rpress-discount",$checkout_form_wrap).val(""),recalculate_taxes();var inputs=$("#rpress_cc_fields .rpress-input, #rpress_cc_fields .rpress-select,#rpress_cc_address .rpress-input, #rpress_cc_address .rpress-select,#rpress_payment_mode_select .rpress-input, #rpress_payment_mode_select .rpress-select");"0.00"==discount_response.total_plain?($("#rpress_cc_fields,#rpress_cc_address,#rpress_payment_mode_select").slideUp(),inputs.removeAttr("required"),$('input[name="rpress-gateway"]').val("manual")):(inputs.is(".card-address-2")||inputs.attr("required","required"),$("#rpress_cc_fields,#rpress_cc_address").slideDown()),$body.trigger("rpress_discount_applied",[discount_response])}else $("#rpress-discount-error-wrap").html('<span class="rpress_error">'+discount_response.msg+"</span>"),$("#rpress-discount-error-wrap").show(),$body.trigger("rpress_discount_invalid",[discount_response]);else window.console&&window.console.log&&console.log(discount_response),$body.trigger("rpress_discount_failed",[discount_response]);rpress_discount_loader.hide()}}).fail(function(data){window.console&&window.console.log&&console.log(data)}),!1}function remove_discount(event){var postData={action:"rpress_remove_discount",code:$(this).data("code")};return $.ajax({type:"POST",data:postData,dataType:"json",url:rpress_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(discount_response){var zero="0"+rpress_global_vars.decimal_separator+"00";$(".rpress_cart_amount").each(function(){rpress_global_vars.currency_sign+zero!=$(this).text()&&zero+rpress_global_vars.currency_sign!=$(this).text()||window.location.reload(),$(this).text(discount_response.total),$(this).data("total",discount_response.total_plain)}),$(".rpress_cart_discount").html(discount_response.html),discount_response.discounts||$(".rpress_cart_discount_row").hide(),recalculate_taxes(),$("#rpress_cc_fields,#rpress_cc_address").slideDown(),$body.trigger("rpress_discount_removed",[discount_response])}}).fail(function(data){window.console&&window.console.log&&console.log(data)}),!1}function update_item_quantities(event){var $this=$(this),quantity=$this.val(),key=$this.data("key"),fooditem_id=$this.closest(".rpress_cart_item").data("fooditem-id"),options=$this.parent().find('input[name="rpress-cart-fooditem-'+key+'-options"]').val(),rpress_cc_address=$("#rpress_cc_address"),postData={action:"rpress_update_quantity",quantity:quantity,fooditem_id:fooditem_id,options:options,billing_country:rpress_cc_address.find("#billing_country").val(),card_state:rpress_cc_address.find("#card_state").val()};return $.ajax({type:"POST",data:postData,dataType:"json",url:rpress_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(response){$(".rpress_cart_subtotal_amount").each(function(){$(this).text(response.subtotal)}),$(".rpress_cart_tax_amount").each(function(){$(this).text(response.taxes)}),$(".rpress_cart_amount").each(function(){$(this).text(response.total),$body.trigger("rpress_quantity_updated",[response])})}}).fail(function(data){window.console&&window.console.log&&console.log(data)}),!1}return{init:function(){$body=$(document.body),$form=$("#rpress_purchase_form"),$rpress_cart_amount=$(".rpress_cart_amount"),$rpress_cart_amount.text(),$checkout_form_wrap=$("#rpress_checkout_form_wrap"),$body.on("rpress_gateway_loaded",function(e){var form,card_number,card_cvc,card_expiry;card_number=(form=$form).find(".card-number"),card_cvc=form.find(".card-cvc"),card_expiry=form.find(".card-expiry"),card_number.length&&"function"==typeof card_number.payment&&(card_number.payment("formatCardNumber"),card_cvc.payment("formatCardCVC"),card_expiry.payment("formatCardExpiry"))}),$body.on("keyup change",".rpress-do-validate .card-number",function(){var field,card_field;field=$(this),(card_field=field).validateCreditCard(function(result){var $card_type=$(".card-type");null==result.card_type?($card_type.removeClass().addClass("off card-type"),card_field.removeClass("valid"),card_field.addClass("error")):($card_type.removeClass("off"),$card_type.addClass(result.card_type.name),result.length_valid&&result.luhn_valid?(card_field.addClass("valid"),card_field.removeClass("error")):(card_field.removeClass("valid"),card_field.addClass("error")))})}),$body.on("blur change",".card-name",function(){var name_field=$(this);name_field.validateCreditCard(function(result){null!=result.card_type?(name_field.removeClass("valid").addClass("error"),$("#rpress-purchase-button").attr("disabled","disabled")):(name_field.removeClass("error").addClass("valid"),$("#rpress-purchase-button").removeAttr("disabled"))})}),$body.on("submit","#rpress_payment_mode",function(){if(0==$("#rpress-gateway option:selected").val())return alert(rpress_global_vars.no_gateway),!1}),$body.on("click","#rpress_payment_mode_select input",function(){$("#rpress_payment_mode_select label.rpress-gateway-option-selected").removeClass("rpress-gateway-option-selected"),$("#rpress_payment_mode_select input:checked").parent().addClass("rpress-gateway-option-selected")}),$checkout_form_wrap.on("click",".rpress-apply-discount",apply_discount),$checkout_form_wrap.on("keypress","#rpress-discount",function(event){if("13"==event.keyCode)return!1}),$checkout_form_wrap.on("keyup","#rpress-discount",function(event){"13"==event.keyCode&&$checkout_form_wrap.find(".rpress-apply-discount").trigger("click")}),$body.on("click",".rpress_discount_remove",remove_discount),$body.on("click",".rpress_discount_link",function(e){e.preventDefault(),$(".rpress_discount_link").parent().hide(),$("#rpress-discount-code-wrap").show().find("#rpress-discount").focus()}),$body.find("#rpress-discount-code-wrap").hide(),$body.find("#rpress_show_discount").show(),$body.on("change",".rpress-item-quantity",update_item_quantities),$body.on("click",".rpress-amazon-logout #Logout",function(e){e.preventDefault(),amazon.Login.logout(),window.location=rpress_amazon.checkoutUri})},recalculate_taxes:recalculate_taxes}}(window.jQuery),window.jQuery(document).ready(RPRESS_Checkout.init);var ajax_tax_count=0;function recalculate_taxes(state){if("1"==rpress_global_vars.taxes_enabled){var $rpress_cc_address=jQuery("#rpress_cc_address");state||(state=$rpress_cc_address.find("#card_state").val());var postData={action:"rpress_recalculate_taxes",billing_country:$rpress_cc_address.find("#billing_country").val(),state:state,card_zip:$rpress_cc_address.find("input[name=card_zip]").val()},current_ajax_count=++ajax_tax_count;jQuery.ajax({type:"POST",data:postData,dataType:"json",url:rpress_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(tax_response){if(current_ajax_count===ajax_tax_count){jQuery("#rpress_checkout_cart_form").replaceWith(tax_response.html),jQuery(".rpress_cart_amount").html(tax_response.total);var tax_data=new Object;tax_data.postdata=postData,tax_data.response=tax_response,jQuery("body").trigger("rpress_taxes_recalculated",[tax_data])}}}).fail(function(data){window.console&&window.console.log&&(console.log(data),current_ajax_count===ajax_tax_count&&jQuery("body").trigger("rpress_taxes_recalculated",[tax_data]))})}}